# NixOS Config Information

## Purpose

This document is intended to serve as a refresher to myself about the intricacies of my NixOS configuration.  This is my first NixOS installation, so there are bound to be plenty of mistakes present, but my goal is to fully switch over to NixOS from Windows 10/11.  I have a minor to moderate amount of experience with Linux (not a sys admin but not afraid of the terminal) so I have high hopes that I will be able to fully transition within a few months.

In an ideal world, I would just fully switch over and figure it out, but I don't have enough free time to get my Nix system to have functional equivalence to my current Windows systems.  My strategy for now is just to dual-boot and work on setting up NixOS a little bit every week.

## Common Commands

### Update Flake Inputs
```
sudo nix flake update --flake <path_to_folder_with_flake.nix>
```
This updates `flake.lock` to the latest versions of all inputs (nixpkgs, home-manager, lanzaboote, etc.).

### Rebuild System
```
sudo nixos-rebuild switch --flake <path_to_folder_with_flake.nix>
```
Builds and activates the configuration from the current `flake.lock`.  The `--upgrade` flag is a **channels** feature and has no effect here since channels are disabled.  The correct workflow is: run `nix flake update` first, then `nixos-rebuild switch`.

## Structure

### `flake.nix`
The top-level entry point for the entire configuration.  Defines:
- **Inputs**: `nixpkgs` (unstable), `nixpkgs-stable` (for version rollback), `home-manager`, and `lanzaboote` (secure boot).
- **Identity variables**: `userName`, `userDescription`, and `hostName` are defined here in one place and passed to all modules via `specialArgs`/`extraSpecialArgs` so they never need to be hardcoded elsewhere.
- **Outputs**: Custom packages (`pkgs/`), overlays (`overlays/`), the formatter, and the NixOS system configuration for `TERRA-NIXOS`.

### `flake.lock`
Auto-generated lock file that pins the exact versions of all flake inputs.  This ensures builds are reproducible.  Updated by `nix flake update`.

### `nixos/configuration.nix`
The main NixOS module.  Responsible for:
- Importing `hardware-configuration.nix`, `core/`, `sysapps/`, and the Home Manager NixOS module.
- Applying overlays and enabling unfree packages.
- Configuring nix settings (flakes, registry, disabling channels).
- Defining the user account (using identity variables from `flake.nix`).
- Configuring Home Manager integration (`useGlobalPkgs`, `useUserPackages`).
- Declaring system-wide packages and services (OpenRazer, LACT, input-remapper, mlocate).

### `nixos/hardware-configuration.nix`
Auto-generated by `nixos-generate-config`.  Defines hardware-specific settings like kernel modules, filesystem mounts, and CPU microcode.  **Do not edit by hand** — it may be overwritten by future invocations of `nixos-generate-config`.

### `nixos/core/`
Modularized core system configuration, united by `default.nix` which imports:
| File | Purpose |
|---|---|
| `audio.nix` | PipeWire audio (with PulseAudio compatibility and ALSA 32-bit support) |
| `bootloader.nix` | Lanzaboote secure boot, EFI settings, and Windows dual-boot entry |
| `desktop.nix` | GNOME desktop environment, GDM display manager, and CUPS printing |
| `graphics.nix` | Nvidia GPU drivers (open kernel module), X11, and keyboard layout |
| `locale.nix` | Timezone (America/Phoenix) and locale settings (en_US.UTF-8) |
| `networking.nix` | Hostname, firewall rules, and NetworkManager |

### `sysapps/`
System-level application configurations that enable NixOS modules (as opposed to user-level apps in Home Manager).  Currently contains:
- `steam.nix` — Steam with remote play firewall, protontricks, and extest.

### `home-manager/home.nix`
User-level configuration managed by Home Manager (running as a NixOS module).  Uses `useGlobalPkgs` so it shares the system's nixpkgs instance and overlays.  Manages:
- **User packages**: Firefox, Floorp, Proton Pass, Vesktop, Discord (with Vencord), ProtonVPN, Obsidian, FileZilla.
- **Programs**: VS Code, Calibre, Git.
- **User services**: ProtonVPN auto-start on login.

### `overlays/default.nix`
Defines three overlays applied to nixpkgs:
- `additions` — Exposes custom packages from the `pkgs/` directory.
- `modifications` — For overriding existing nixpkgs packages (currently empty).
- `stable-packages` — Makes `nixpkgs-stable` available as `pkgs.stable` for version rollback.

### `pkgs/default.nix`
Custom package definitions, buildable via `nix build .#<name>`.  Currently empty (placeholder for future use).

## Acknowledgement
The current configuration borrows from [the nix-starter-configs](https://github.com/Misterio77/nix-starter-configs/tree/main) repo by [Misterio77](https://github.com/Misterio77).  Their repository made it much easier to start configuring my setup.